<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DavintoHQ Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

  <div class="bg-indigo-700 text-white text-center py-4 shadow">
    <h1 class="text-xl font-bold">DavintoHQ Group Chat</h1>
    <p id="user-info" class="text-sm mt-1"></p>
  </div>

  <main class="flex-1 p-4 overflow-y-auto" id="messages"></main>

  <form id="chat-form" class="p-4 bg-white border-t shadow flex items-center gap-2">
    <input type="text" id="message" placeholder="Type a message..." class="flex-1 border px-4 py-2 rounded" />
    <input type="file" id="file" class="hidden" />
    <button type="button" onclick="document.getElementById('file').click()" class="bg-gray-200 px-3 py-2 rounded">ðŸ“Ž</button>
    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Send</button>
  </form>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDT5tgWOLu3oUf7XTFsFzAuszUcERhoOTw",
      authDomain: "davintohq.firebaseapp.com",
      projectId: "davintohq",
      storageBucket: "davintohq.firebasestorage.app",
      messagingSenderId: "156992522736",
      appId: "1:156992522736:web:7db1c51a089d9d1bad3535",
      measurementId: "G-3GXFN90T6S"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    const storage = getStorage();

    const messagesRef = collection(db, "messages");

    const ownerEmail = "macdinodavinto@gmail.com";
    const ownerPhone = "+2348169045105";

    let currentUser;

    onAuthStateChanged(auth, user => {
      if (!user) return window.location.href = "index.html";
      currentUser = user;

      const isOwner = user.email === ownerEmail || user.phoneNumber === ownerPhone;
      document.getElementById("user-info").innerText = `Logged in as ${user.email || user.phoneNumber}${isOwner ? " (Admin)" : ""}`;

      const q = query(messagesRef, orderBy("timestamp", "asc"));
      onSnapshot(q, snapshot => {
        const messagesEl = document.getElementById("messages");
        messagesEl.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "mb-3";
          div.innerHTML = `
            <div class="p-3 rounded-lg ${data.uid === user.uid ? 'bg-indigo-100 ml-auto' : 'bg-white'} max-w-[80%] shadow">
              <p class="text-sm text-gray-600 mb-1"><b>${data.sender || 'Anonymous'}:</b></p>
              ${data.text ? `<p>${data.text}</p>` : ""}
              ${data.fileURL ? `<img src="${data.fileURL}" class="mt-2 max-h-48 rounded" />` : ""}
              <p class="text-xs text-gray-400 mt-1">${new Date(data.timestamp?.toDate()).toLocaleTimeString()}</p>
            </div>
          `;
          messagesEl.appendChild(div);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        });
      });
    });

    document.getElementById("chat-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("message").value.trim();
      const fileInput = document.getElementById("file");
      let fileURL = null;

      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const storageRef = ref(storage, `uploads/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        fileURL = await getDownloadURL(storageRef);
        fileInput.value = ""; // reset file
      }

      if (!msg && !fileURL) return;

      await addDoc(messagesRef, {
        uid: currentUser.uid,
        sender: currentUser.email || currentUser.phoneNumber || "Unknown",
        text: msg || null,
        fileURL: fileURL || null,
        timestamp: serverTimestamp()
      });

      document.getElementById("message").value = "";
    });
  </script>
</body>
</html>
