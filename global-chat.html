<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DavintoHQ - Global Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chatContainer {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #f0f0f0;
    }
    .message {
      background: #fff;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
      position: relative;
    }
    .username {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .time {
      font-size: 0.75rem;
      color: gray;
      position: absolute;
      top: 5px;
      right: 10px;
    }
    #inputArea {
      display: flex;
      border-top: 1px solid #ccc;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      font-size: 1rem;
      border: none;
    }
    #sendBtn {
      padding: 10px 20px;
      background: #4caf50;
      color: white;
      border: none;
      cursor: pointer;
    }
    #sendBtn:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <div id="chatContainer"></div>
  <div id="inputArea">
    <input type="text" id="messageInput" placeholder="Type your message here..." />
    <button id="sendBtn">Send</button>
  </div>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot,
      serverTimestamp, query, orderBy, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAx0q_QGU35tLFP4MtUMQQUtw-WVNagpHk",
      authDomain: "izuchukwu-foods.firebaseapp.com",
      projectId: "izuchukwu-foods",
      storageBucket: "izuchukwu-foods.appspot.com",
      messagingSenderId: "811147638426",
      appId: "1:811147638426:web:f2403b6cf7e0b6f19b1123"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const chatContainer = document.getElementById("chatContainer");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    let currentUser = null;
    let userCache = {};

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (!snap.exists()) {
          await setDoc(userRef, {
            username: user.email.split("@")[0],
            email: user.email,
            createdAt: serverTimestamp()
          });
        }
        loadMessages();
      } else {
        alert("Please sign in first.");
      }
    });

    function renderMessage(msg, id) {
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `
        <div class="username">${msg.username || "Unnamed"}</div>
        <div>${msg.text}</div>
        <div class="time">${new Date(msg.timestamp?.toDate?.() || Date.now()).toLocaleTimeString()}</div>
      `;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function loadMessages() {
      const q = query(collection(db, "chats"), orderBy("timestamp"));
      onSnapshot(q, async (snapshot) => {
        chatContainer.innerHTML = "";
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          if (!data.username && data.uid) {
            if (!userCache[data.uid]) {
              const userSnap = await getDoc(doc(db, "users", data.uid));
              userCache[data.uid] = userSnap.exists() ? userSnap.data().username || "Unnamed" : "Unknown";
            }
            data.username = userCache[data.uid];
          }
          renderMessage(data, docSnap.id);
        }
      });
    }

    sendBtn.addEventListener("click", async () => {
      const text = messageInput.value.trim();
      if (!text || !currentUser) return;
      const userSnap = await getDoc(doc(db, "users", currentUser.uid));
      const username = userSnap.exists() ? userSnap.data().username : currentUser.email;
      await addDoc(collection(db, "chats"), {
        text,
        uid: currentUser.uid,
        username,
        timestamp: serverTimestamp()
      });
      messageInput.value = "";
    });
  </script></body>
</html>