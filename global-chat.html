<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Global Chat</title>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f1f1f1;
      margin: 0;
      padding: 0;
    }
    .chat-container {
      width: 100%;
      max-width: 600px;
      margin: auto;
      padding-top: 40px;
    }
    .messages {
      border: 1px solid #ccc;
      background: white;
      padding: 10px;
      height: 400px;
      overflow-y: scroll;
      margin-bottom: 10px;
    }
    .message {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .message .meta {
      font-size: 12px;
      color: gray;
    }
    .input-area {
      display: flex;
    }
    .input-area input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-right: none;
      font-size: 16px;
    }
    .input-area button {
      padding: 10px 20px;
      border: none;
      background: #007bff;
      color: white;
      font-size: 16px;
    }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <input type="text" id="messageInput" placeholder="Type your message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDT5tgWOLu3oUf7XTFsFzAuszUcERhoOTw",
    authDomain: "davintohq.firebaseapp.com",
    projectId: "davintohq",
    storageBucket: "davintohq.appspot.com",
    messagingSenderId: "156992522736",
    appId: "1:156992522736:web:7db1c51a089d9d1bad3535"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;
  let username = 'Anonymous';

  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;

      const userDoc = await db.collection('users').doc(user.uid).get();
      username = userDoc.exists ? userDoc.data().username || "Anonymous" : "Anonymous";

      listenForMessages();
    } else {
      await auth.signInAnonymously();
    }
  });

  function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text) return;

    db.collection('chats').add({
      text,
      uid: currentUser.uid,
      username: username,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      input.value = "";
    }).catch(error => {
      alert("Error: " + error.message);
    });
  }

  function listenForMessages() {
    db.collection('chats').orderBy('timestamp')
      .onSnapshot(snapshot => {
        const container = document.getElementById('messages');
        container.innerHTML = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement('div');
          div.classList.add('message');
          div.innerHTML = `
            <div><strong>${msg.username}</strong>: ${msg.text}</div>
            <div class="meta">${msg.timestamp?.toDate().toLocaleString() || ''}</div>
          `;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      });
  }
</script>
</body>
</html>