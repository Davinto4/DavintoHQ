<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Chat - DavintoHQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex min-h-screen">
  <div id="sidebar"></div>

  <main class="flex-1 flex flex-col">
    <header class="bg-white shadow p-4">
      <h1 class="text-xl font-bold text-blue-600">üåê Global Chat</h1>
    </header>

    <section id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-2"></section>

    <form id="chatForm" class="bg-white p-4 flex gap-2 border-t">
      <input
        type="text"
        id="messageInput"
        class="flex-1 p-2 border rounded"
        placeholder="Type a message"
        required
      />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Send</button>
    </form>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      onSnapshot, doc, deleteDoc, updateDoc, query, orderBy
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import {
      getAuth, onAuthStateChanged, signInAnonymously
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDT5tgWOLu3oUf7XTFsFzAuszUcERhoOTw",
      authDomain: "davintohq.firebaseapp.com",
      projectId: "davintohq",
      storageBucket: "davintohq.appspot.com",
      messagingSenderId: "156992522736",
      appId: "1:156992522736:web:7db1c51a089d9d1bad3535"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore();
    const auth = getAuth();

    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const messageInput = document.getElementById("messageInput");

    let currentUser = null;

    function createMessageElement(docSnap, userId) {
      const data = docSnap.data();
      const isSender = data.senderId === userId;

      const div = document.createElement("div");
      div.className = `p-2 rounded max-w-[75%] relative ${
        isSender ? "bg-blue-100 self-end text-right ml-auto" : "bg-white"
      }`;
      div.innerHTML = `
        <p class="text-sm font-semibold">${data.senderName || "Anonymous"}</p>
        <p class="text-md">${data.text}</p>
        <p class="text-xs text-gray-500">${new Date(data.timestamp?.toDate()).toLocaleTimeString()}</p>
        ${
          isSender
            ? `<button class="absolute top-1 right-1 text-gray-400 hover:text-black options-btn">‚ãÆ</button>
               <div class="hidden absolute top-6 right-1 bg-white border rounded shadow p-1 z-10 options-menu">
                 <button class="text-sm text-blue-600 edit-btn">Edit</button>
                 <button class="text-sm text-red-500 delete-btn">Delete</button>
               </div>`
            : ""
        }
      `;

      // Add event listener for options menu toggle
      const optionsBtn = div.querySelector(".options-btn");
      const optionsMenu = div.querySelector(".options-menu");
      if (optionsBtn && optionsMenu) {
        optionsBtn.onclick = (e) => {
          e.stopPropagation();
          document.querySelectorAll(".options-menu").forEach(menu => menu.classList.add("hidden"));
          optionsMenu.classList.toggle("hidden");
        };
      }

      // Delete message
      const deleteBtn = div.querySelector(".delete-btn");
      if (deleteBtn) {
        deleteBtn.onclick = async () => {
          if (confirm("Delete this message?")) {
            await deleteDoc(doc(db, "globalChats", docSnap.id));
          }
        };
      }

      // Edit message
      const editBtn = div.querySelector(".edit-btn");
      if (editBtn) {
        editBtn.onclick = async () => {
          const newText = prompt("Edit message:", data.text);
          if (newText && newText !== data.text) {
            await updateDoc(doc(db, "globalChats", docSnap.id), {
              text: newText,
              edited: true
            });
          }
        };
      }

      return div;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        await signInAnonymously(auth);
        return;
      }

      currentUser = user;

      const q = query(collection(db, "globalChats"), orderBy("timestamp"));
      onSnapshot(q, snapshot => {
        chatBox.innerHTML = "";
        snapshot.forEach(docSnap => {
          const msg = createMessageElement(docSnap, user.uid);
          chatBox.appendChild(msg);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    });

    chatForm.onsubmit = async (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;

      await addDoc(collection(db, "globalChats"), {
        senderId: currentUser.uid,
        senderName: currentUser.email || "Guest",
        text,
        timestamp: serverTimestamp()
      });

      messageInput.value = "";
    };

    document.body.onclick = () => {
      document.querySelectorAll(".options-menu").forEach(menu => menu.classList.add("hidden"));
    };

    import("./sidebar.js").then(m => m.loadSidebar());
  </script>
</body>
</html>