<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Admins - DavintoHQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="flex min-h-screen bg-gray-100">
  <div id="sidebar"></div>

  <main class="flex-1 p-6">
    <h1 class="text-2xl font-bold mb-4 text-blue-700">üõ°Ô∏è Manage Admins</h1>

    <div class="flex items-center space-x-4 mb-4">
      <input id="searchInput" type="text" placeholder="Search by username, email, or phone"
             class="p-2 border rounded w-full max-w-md" />
      <label class="flex items-center space-x-2">
        <input type="checkbox" id="showOnlyAdmins" />
        <span>Show only admins</span>
      </label>
      <button id="exportCSV" class="bg-green-600 text-white px-3 py-1 rounded">Export CSV</button>
      <button id="exportPDF" class="bg-red-600 text-white px-3 py-1 rounded">Export PDF</button>
    </div>

    <div id="results" class="space-y-4"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDT5tgWOLu3oUf7XTFsFzAuszUcERhoOTw",
      authDomain: "davintohq.firebaseapp.com",
      projectId: "davintohq",
      storageBucket: "davintohq.appspot.com",
      messagingSenderId: "156992522736",
      appId: "1:156992522736:web:7db1c51a089d9d1bad3535"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    const ownerEmail = "macdinodavinto@gmail.com";
    const ownerPhone = "+2348169045105";

    let allUsers = [];
    let adminUIDs = new Set();

    const searchInput = document.getElementById("searchInput");
    const resultsDiv = document.getElementById("results");
    const showOnlyAdmins = document.getElementById("showOnlyAdmins");

    function renderResults() {
      const query = searchInput.value.trim().toLowerCase();
      const onlyAdmins = showOnlyAdmins.checked;

      const filtered = allUsers.filter(user => {
        const match = user.username.toLowerCase().includes(query)
          || user.email.toLowerCase().includes(query)
          || user.phone.toLowerCase().includes(query);

        return match && (!onlyAdmins || adminUIDs.has(user.uid));
      });

      if (filtered.length === 0) {
        resultsDiv.innerHTML = "<p class='text-gray-500'>No users found.</p>";
        return;
      }

      resultsDiv.innerHTML = filtered.map(user => `
        <div class="bg-white shadow p-4 rounded flex justify-between items-center">
          <div>
            <p><strong>Username:</strong> ${user.username}</p>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>Phone:</strong> ${user.phone}</p>
            <p><strong>Role:</strong> ${adminUIDs.has(user.uid) ? "admin" : "user"}</p>
          </div>
          <div>
            <button onclick="${adminUIDs.has(user.uid) ?
              `removeAdmin('${user.uid}')` : `addAdmin('${user.uid}')`}"
              class="${adminUIDs.has(user.uid) ? 'bg-red-600' : 'bg-blue-600'} text-white px-3 py-1 rounded">
              ${adminUIDs.has(user.uid) ? 'Remove Admin' : 'Make Admin'}
            </button>
          </div>
        </div>
      `).join('');
    }

    async function loadUsersAndAdmins() {
      const usersSnap = await getDocs(collection(db, "users"));
      const adminsSnap = await getDocs(collection(db, "admins"));

      adminUIDs = new Set(adminsSnap.docs.map(d => d.id));

      allUsers = usersSnap.docs.map(doc => ({
        uid: doc.id,
        ...doc.data(),
        username: doc.data().username || "(no username)",
        email: doc.data().email || "-",
        phone: doc.data().phone || "-"
      }));

      renderResults();
    }

    async function addAdmin(uid) {
      await setDoc(doc(db, "admins", uid), { createdAt: Date.now() });
      adminUIDs.add(uid);
      renderResults();
    }

    async function removeAdmin(uid) {
      await deleteDoc(doc(db, "admins", uid));
      adminUIDs.delete(uid);
      renderResults();
    }

    searchInput.addEventListener("input", renderResults);
    showOnlyAdmins.addEventListener("change", renderResults);

    document.getElementById("exportCSV").addEventListener("click", () => {
      const rows = [["Username", "Email", "Phone", "Role"]];
      allUsers.forEach(user => {
        if (!adminUIDs.has(user.uid)) return;
        rows.push([user.username, user.email, user.phone, "admin"]);
      });
      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "admins.csv";
      a.click();
    });

    document.getElementById("exportPDF").addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      let y = 10;

      pdf.setFontSize(12);
      pdf.text("Admin List", 10, y);
      y += 10;

      allUsers.forEach(user => {
        if (!adminUIDs.has(user.uid)) return;
        pdf.text(`‚Ä¢ ${user.username} | ${user.email} | ${user.phone}`, 10, y);
        y += 8;
        if (y > 280) {
          pdf.addPage();
          y = 10;
        }
      });

      pdf.save("admins.pdf");
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "index.html";

      const isOwner = user.email === ownerEmail || user.phoneNumber === ownerPhone;
      if (!isOwner) return location.href = "unauthorized.html";

      await loadUsersAndAdmins();
    });

    import("./sidebar.js").then(m => m.loadSidebar());
  </script>
</body>
</html>