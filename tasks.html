<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DavintoHQ Tasks</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .task { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
    .admin-only { margin-bottom: 30px; padding: 10px; background: #f9f9f9; border-left: 4px solid #333; }
  </style>
</head>
<body>

  <h2>DavintoHQ Tasks</h2>
  <div id="welcome"></div>

  <div id="adminPanel" class="admin-only" style="display:none;">
    <h3>Assign Task (Admins Only)</h3>
    <input type="text" id="targetUsername" placeholder="Recipient Username"><br><br>
    <input type="text" id="taskTitle" placeholder="Task Title"><br><br>
    <textarea id="taskDesc" placeholder="Task Description"></textarea><br><br>
    <button onclick="assignTask()">Assign Task</button>
    <p id="status"></p>
  </div>

  <h3>Your Tasks</h3>
  <div id="taskList"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDT5tgWOLu3oUf7XTFsFzAuszUcERhoOTw",
      authDomain: "davintohq.firebaseapp.com",
      projectId: "davintohq",
      storageBucket: "davintohq.appspot.com",
      messagingSenderId: "156992522736",
      appId: "1:156992522736:web:7db1c51a089d9d1bad3535"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let currentUserData = null;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        const userDoc = await db.collection('users').doc(user.uid).get();
        currentUserData = userDoc.data();
        document.getElementById("welcome").innerHTML =
          `<p>Hello <strong>${currentUserData?.username || "User"}</strong> 👋</p>`;

        // Show admin task panel if role is admin or owner
        if (["admin", "owner"].includes(currentUserData?.role)) {
          document.getElementById("adminPanel").style.display = "block";
        }

        loadTasks(currentUserData?.username);
      } else {
        alert("Please login to view tasks.");
      }
    });

    async function assignTask() {
      const username = document.getElementById("targetUsername").value.trim();
      const title = document.getElementById("taskTitle").value.trim();
      const desc = document.getElementById("taskDesc").value.trim();
      const statusText = document.getElementById("status");

      if (!username || !title || !desc) {
        statusText.innerText = "All fields are required.";
        return;
      }

      try {
        await db.collection("tasks").add({
          assignedTo: username,
          title: title,
          description: desc,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          assignedBy: currentUserData?.username || "Unknown"
        });
        statusText.innerText = "✅ Task assigned successfully!";
        document.getElementById("targetUsername").value = '';
        document.getElementById("taskTitle").value = '';
        document.getElementById("taskDesc").value = '';
      } catch (e) {
        statusText.innerText = "❌ Failed to assign task: " + e.message;
      }
    }

    function loadTasks(myUsername) {
      db.collection("tasks")
        .where("assignedTo", "==", myUsername)
        .orderBy("createdAt", "desc")
        .onSnapshot(snapshot => {
          const taskList = document.getElementById("taskList");
          taskList.innerHTML = "";
          snapshot.forEach(doc => {
            const task = doc.data();
            const div = document.createElement("div");
            div.className = "task";
            div.innerHTML = `
              <strong>${task.title}</strong><br>
              <small><i>Assigned by ${task.assignedBy || 'admin'}</i></small><br>
              <p>${task.description}</p>
            `;
            taskList.appendChild(div);
          });

          if (snapshot.empty) {
            taskList.innerHTML = "<p>No tasks assigned to you yet.</p>";
          }
        });
    }
  </script>
</body>
</html>