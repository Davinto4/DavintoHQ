<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tasks - DavintoHQ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">Task Manager</h2>

    <div id="admin-section" style="display: none;">
      <h4>Create Task (Admins only)</h4>
      <form id="taskForm" class="mb-4">
        <div class="mb-3">
          <label for="assignee" class="form-label">Assign To (User UID)</label>
          <input type="text" class="form-control" id="assignee" placeholder="Enter user UID" required />
        </div>
        <div class="mb-3">
          <label for="title" class="form-label">Task Title</label>
          <input type="text" class="form-control" id="title" required />
        </div>
        <div class="mb-3">
          <label for="description" class="form-label">Task Description</label>
          <textarea class="form-control" id="description" rows="3" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Add Task</button>
      </form>
    </div>

    <h4>All Tasks</h4>
    <ul id="taskList" class="list-group"></ul>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDT5tgWOLu3oUf7XTFsFzAuszUcERhoOTw",
      authDomain: "davintohq.firebaseapp.com",
      projectId: "davintohq",
      storageBucket: "davintohq.appspot.com",
      messagingSenderId: "156992522736",
      appId: "1:156992522736:web:7db1c51a089d9d1bad3535"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        const userDoc = await db.collection("users").doc(user.uid).get();
        const role = userDoc.exists ? userDoc.data().role : null;

        if (["admin", "owner"].includes(role)) {
          document.getElementById("admin-section").style.display = "block";
        }

        loadTasks();
      } else {
        alert("Please log in to view tasks.");
      }
    });

    document.getElementById("taskForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const assignee = document.getElementById("assignee").value.trim();
      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();

      try {
        await db.collection("tasks").add({
          assignee,
          title,
          description,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser.uid
        });
        alert("Task created successfully.");
        document.getElementById("taskForm").reset();
        loadTasks();
      } catch (error) {
        console.error("Error adding task:", error);
        alert("Error creating task. Ensure you have admin rights.");
      }
    });

    async function loadTasks() {
      const taskList = document.getElementById("taskList");
      taskList.innerHTML = "";
      const snapshot = await db.collection("tasks").orderBy("createdAt", "desc").get();

      for (const doc of snapshot.docs) {
        const task = doc.data();
        const assigneeName = await getUsername(task.assignee);
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.innerHTML = `
          <strong>${task.title}</strong><br/>
          <small>Assigned to: ${assigneeName || task.assignee}</small><br/>
          <p>${task.description}</p>
        `;
        taskList.appendChild(li);
      }
    }

    async function getUsername(uid) {
      if (!uid) return null;
      try {
        const userDoc = await db.collection("users").doc(uid).get();
        return userDoc.exists ? userDoc.data().username || userDoc.data().email : null;
      } catch (err) {
        return null;
      }
    }
  </script>
</body>
</html>